extends header

block content

  style(type="text/css").

  
  script(type="text/javascript").
  
    $(document).ready(function(){

        const socket = io()

        socket.on('connect', () => {
            alertify.success('Web Socket Conectado')
            console.log(socket)
        })

        socket.on('msg', (msg) => {
            if(msg == 'finish'){
                alertify.success('Processamento Finalizado')
                mostraStatus()
            }
        })

        var lastUUID = ''

        $('#frm_upload_doc').submit(function(e){

            e.preventDefault()

            // Recupera os arquivos do input file
            var file = $('#file_doc')[0].files[0]

            if(file == undefined){
                alertify.error('Selecione um arquivo JPEG/TIFF')
            }
            else{

                alertify.success('Iniciando processamento OCR', 10)

                // Monta um objeto FormData com os arquivos
                var formData = new FormData();
                formData.append('file_doc', file);
                formData.append('socket_id', socket.id)

                $('#ocr_result').text('Processando OCR ...')
                
                // Envia ajax para processar o upload
                var promise = $.ajax({
                    url: 'process_ocr',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    enctype: 'multipart/form-data',
                    processData: false
                })
                
                promise.then(function (result) {
                    
                    //- console.log("============================")
                    //- console.log(response)
                    //- $('#ocr_result').text(response)

                    lastUUID = result
                    $('#ocr_result').text(JSON.stringify(result))

                })

            }

        })

        $('#frm_process_ocr').submit(function(e){

            e.preventDefault()

            var data = $(this).serialize();

            console.log(data)

            var promise = $.ajax({
                url: 'process_ocr',
                type: 'POST',
                data: data
            })

            promise.then(function(result){
                lastUUID = result
                $('#ocr_result').text(JSON.stringify(result))
            })

        })

        $('#btn_consultar_status').click(function(e){

            e.preventDefault()

            mostraStatus()

        })

        function mostraStatus(e){

            let _url = 'status_ocr/'+lastUUID._uuid

            var promise = $.ajax({
                url: _url,
                type: 'GET'
            })

            promise.then(function(result){
                $('#status_ocr').text(JSON.stringify(result, undefined, 2))
            })
        }
      
    })  

    
  div(class='container')
    div(style="float:left;width:40%")
        h2 Modulo de Teste - OCR Google Cloud Vision
        //- a(class='btn btn-info' href='get_all_files'  target='_blank') Listar Urls dos Textos
        hr
        h3 Metodo Upload do Computador
        form(method="post" id="frm_upload_doc" enctype="multipart/form-data")
            //- input(class='form-control' type='file' name='file_doc' id='file_doc' accept=".jpg,.jpeg,.png,.tiff")
            input(class='form-control' type='file' name='file_doc' id='file_doc' accept=".pdf")
            br
            input(class='btn btn-success' type='submit' value='enviar' id='btn_enviar')
        hr
        h3 Metodo por URL Externa
        form(method="post" id="frm_process_ocr")
            input(class="form-control" type="text" id="urlFile" name="urlFile")
            br
            input(class='btn btn-success' type='submit' value='enviar' id='btn_enviar_ocr')
            br
        //- a(id='url_ocr_atual')
        pre(id='ocr_result')
        //- hr
        //- h3 Consultar Status OCR (Ultimo UUID)
        //- br
        //- input(class='btn btn-success' type='button' value='consultar status' id='btn_consultar_status')
    div(style="float:right; width:50%")
        h3 Status Processamento Full
        br
        pre(id='ocr_result')
        br
        pre(id='status_ocr')